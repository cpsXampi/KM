
name: "Android CI - Build APK (Debug)"

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      # üëâ Corrigido: pacotes em linha √∫nica (com aspas nos que t√™m ;)
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: platform-tools "platforms;android-34" "build-tools;34.0.0"

      # Diagn√≥stico leve pra confirmar a raiz do projeto
      - name: Show workspace layout
        shell: bash
        run: |
          echo "PWD=$(pwd)"
          ls -la
          echo "---- Conte√∫do de RodoviaRecorder-MVP ----"
          ls -la RodoviaRecorder-MVP || true
          echo "---- settings.gradle(.kts) ----"
          (cat RodoviaRecorder-MVP/settings.gradle || cat RodoviaRecorder-MVP/settings.gradle.kts) 2>/dev/null || true

      # Garante wrapper e vers√£o do Gradle/AGP compat√≠veis com o projeto
      - name: Sanity check Gradle wrapper
        shell: bash
        working-directory: RodoviaRecorder-MVP
        run: |
          test -f gradlew || { echo "gradlew n√£o encontrado!"; exit 2; }
          chmod +x gradlew
          ./gradlew --version

      # Usa o gradle-build-action com o wrapper do projeto (n√£o for√ßa vers√£o)
      - name: Build with Gradle (assembleDebug)
        uses: gradle/gradle-build-action@v3
        with:
          build-root-directory: RodoviaRecorder-MVP
          arguments: "assembleDebug --stacktrace --warning-mode all --no-daemon"

      # Sempre coleta relat√≥rios p/ facilitar debug se falhar
      - name: Upload build reports (sempre)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            RodoviaRecorder-MVP/**/build/reports/**
            RodoviaRecorder-MVP/**/build/outputs/**
            RodoviaRecorder-MVP/**/build/*.log
          if-no-files-found: warn

      # APK de debug
      - name: Upload APK (se existir)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: km-debug-apk
          path: RodoviaRecorder-MVP/app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
``
